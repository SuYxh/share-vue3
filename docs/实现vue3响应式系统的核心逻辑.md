å®ç° vue3 å“åº”å¼ç³»ç»Ÿæ ¸å¿ƒ

## ç®€ä»‹

2023 å¹´ 12 æœˆ 31 æ—¥ï¼Œvue2 å·²ç»åœæ­¢ç»´æŠ¤äº†ã€‚ä½ è¿˜ä¸ä¼š Vue3 çš„æºç ä¹ˆï¼Ÿæ‰‹æŠŠæ‰‹å¸¦ä½ å®ç°ä¸€ä¸ª vue3 å“åº”å¼ç³»ç»Ÿã€‚

ä½ å°†è·å¾—ï¼š

- æ€æƒ³
  - TDD æµ‹è¯•é©±åŠ¨å¼€å‘
  - é‡æ„
- å·¥ç¨‹
  - [vitest](https://cn.vitest.dev/) çš„ä½¿ç”¨
  - å¦‚ä½•ä½¿ç”¨  [ChatGPT](https://ask.vuejs.news/) ç¼–å†™å•å…ƒæµ‹è¯•
- åŸç†
  - å“åº”å¼æ•°æ®ä»¥åŠå‰¯ä½œç”¨å‡½æ•°
  - å“åº”å¼ç³»ç»ŸåŸºæœ¬å®ç°
  - Vue3 çš„å“åº”å¼çš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆæ ·ï¼Ÿä¸ºä»€ä¹ˆæ˜¯è¿™æ ·ï¼Ÿå¦‚ä½•å½¢æˆçš„ï¼Ÿ
  - Proxy ä¸ºä»€ä¹ˆè¦é…åˆ Reflect ä½¿ç”¨ï¼Ÿå¦‚æœä¸é…åˆä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ
  - å¦‚ä½•å®Œå–„å“åº”å¼ç³»ç»Ÿ
  - ä¾èµ–æ”¶é›†
  - æ´¾å‘æ›´æ–°
  - ä¾èµ–æ¸…ç†
  - æ”¯æŒåµŒå¥—
  - å®ç°æ‰§è¡Œè°ƒåº¦
  - å®ç° computed
  - å®ç° watch
- å·¥å…·
  - typescript çš„ä½¿ç”¨
  - ChatGPT ä½¿ç”¨
  - excalidraw ç”»å›¾å·¥å…·
  - vitest runner

ä»£ç åœ°å€ï¼š https://github.com/SuYxh/share-vue3 

ä»£ç å¹¶æ²¡æœ‰æŒ‰ç…§æºç çš„æ–¹å¼å»è¿›è¡Œç»„ç»‡ï¼Œç›®çš„æ˜¯å­¦ä¹ ã€å®ç° vue3 å“åº”å¼ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œç”¨æœ€å°‘çš„ä»£ç å»å®ç°æœ€æ ¸å¿ƒçš„èƒ½åŠ›ï¼Œå‡å°‘æˆ‘ä»¬çš„å­¦ä¹ è´Ÿæ‹…ï¼Œå¹¶ä¸”æ‰€æœ‰çš„æµç¨‹éƒ½ä¼šæœ‰é…å¥—çš„å›¾ç‰‡ï¼Œå›¾æ–‡+ä»£ç ï¼Œè®©æˆ‘ä»¬å­¦ä¹ æ›´åŠ è½»æ¾ã€å¿«ä¹ã€‚

æ¯ä¸€ä¸ªåŠŸèƒ½éƒ½ä¼šæäº¤ä¸€ä¸ª `commit` ï¼Œå¤§å®¶å¯ä»¥åˆ‡æ¢æŸ¥çœ‹ï¼Œä¹Ÿé¡ºå˜ç»ƒä¹ ç»ƒä¹  git çš„ä½¿ç”¨ã€‚

## ç¯å¢ƒæ­å»º

1ã€ä½¿ç”¨ vite åˆ›å»ºä¸€ä¸ªç©ºæ¨¡æ¿ï¼Œ

```
pnpm init vite
```

2ã€ç„¶åå®‰è£… vitest

```
pnpm add -D vitest
```

ä¸ºä»€ä¹ˆè¦å®‰è£… vitestï¼Ÿ

> æµ‹è¯•é©±åŠ¨å¼€å‘(TDD) æ˜¯ä¸€ç§æ¸è¿›çš„å¼€å‘æ–¹æ³•ï¼Œå®ƒç»“åˆäº†æµ‹è¯•ä¼˜å…ˆçš„å¼€å‘ï¼Œå³åœ¨ç¼–å†™è¶³å¤Ÿçš„äº§å“ä»£ç ä»¥å®Œæˆæµ‹è¯•å’Œé‡æ„ä¹‹å‰ç¼–å†™æµ‹è¯•ã€‚ç›®æ ‡æ˜¯ç¼–å†™æœ‰æ•ˆçš„å¹²å‡€ä»£ç 

3ã€å®‰è£… vscode æ’ä»¶  `Vitest Runner`

![image-20240117095404235](https://qn.huat.xyz/mac/202401170954339.png)

4ã€ç¼–å†™æµ‹è¯•ä»£ç 

åœ¨ mian.js ä¸­ç¼–å†™

```typescript
export function add(a: number, b: number) {
  return a + b;
}
```

åˆ›å»º `/src/__tests__/main.spec.ts`æµ‹è¯•æ–‡ä»¶ï¼Œå†™å…¥ï¼š

```typescript
import { describe, it, expect } from 'vitest';
import { add } from '../main';

describe('add function', () => {
    it('adds two numbers', () => {
        expect(add(1, 2)).toBe(3);
    });
});
```

ç‚¹å‡»è¿è¡Œå•æµ‹ï¼š

![image-20240117100044930](https://qn.huat.xyz/mac/202401171000982.png)

æ³¨æ„ï¼š æˆ‘è¿™è¾¹å› ä¸ºè¿˜å®‰è£…äº† jest runnerï¼Œ æ‰€æœ‰æ­¤å¤„ä¼šæœ‰ 2 å¯¹

è¿è¡Œç»“æœï¼š

![image-20240117100152032](https://qn.huat.xyz/mac/202401171001061.png)

åˆ°æ­¤ï¼Œç¯å¢ƒæ­å»ºç»“æŸï¼ç›¸å…³ä»£ç åœ¨ `commitï¼š (3af5e60)ç¯å¢ƒæ­å»º` ï¼Œ`git checkout 3af5e60` å³å¯æŸ¥çœ‹ã€‚



## å“åº”å¼æ•°æ®ä»¥åŠå‰¯ä½œç”¨å‡½æ•°

å‰¯ä½œç”¨å‡½æ•°æŒ‡çš„æ˜¯ä¼šäº§ç”Ÿå‰¯ä½œç”¨çš„å‡½æ•°ï¼Œå¦‚ä¸‹ï¼š

```typescript
// å…¨å±€å˜é‡
let val = 1

function effect() {
	// ä¿®æ”¹å…¨å±€å˜é‡ï¼Œäº§ç”Ÿå‰¯ä½œç”¨
	val = 2
}
```

å½“ `effect` å‡½æ•°æ‰§è¡Œæ—¶ï¼Œå®ƒä¼šä¿®æ”¹ `val` çš„å€¼ï¼Œä½†é™¤äº† `effect` å‡½æ•°ä¹‹å¤–çš„ä»»ä½•å‡½æ•°éƒ½å¯ä»¥ä¿®æ”¹ `val` çš„å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`effect`å‡½æ•°çš„æ‰§è¡Œä¼šç›´æ¥æˆ–é—´æ¥å½±å“å…¶ä»–å‡½æ•°çš„æ‰§è¡Œï¼Œè¿™æ—¶æˆ‘ä»¬è¯´ `effect` å‡½æ•°äº§ç”Ÿäº†å‰¯ä½œç”¨ã€‚

> ğŸ¤” ä»€ä¹ˆæ˜¯çº¯å‡½æ•°ï¼Ÿ

å‡è®¾åœ¨ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°ä¸­è¯»å–äº†æŸä¸ªå¯¹è±¡çš„å±æ€§ï¼š

```typescript
const obj = { age: 18 }

function effect() {
	console.log(obj.age)
}
```

å½“ obj.age çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å‰¯ä½œç”¨å‡½æ•° `effect`  ä¼šé‡æ–°æ‰§è¡Œï¼Œå¦‚æœèƒ½å®ç°è¿™ä¸ªç›®æ ‡ï¼Œé‚£ä¹ˆå¯¹è±¡ obj å°±æ˜¯å“åº”å¼æ•°æ®ã€‚ä½†å¾ˆæ˜æ˜¾ï¼Œä»¥ä¸Šé¢çš„ä»£ç æ¥çœ‹ï¼Œæˆ‘ä»¬è¿˜åšä¸åˆ°è¿™ä¸€ç‚¹ï¼Œå› ä¸º objæ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œå½“æˆ‘ä»¬ä¿®æ”¹å®ƒçš„å€¼æ—¶ï¼Œé™¤äº†å€¼æœ¬èº«å‘ç”Ÿå˜åŒ–ä¹‹å¤–ï¼Œä¸ä¼šæœ‰ä»»ä½•å…¶ä»–ååº”ã€‚



## å“åº”å¼ç³»ç»ŸåŸºæœ¬å®ç°

å¦‚ä½•å°† `obj` å˜æˆä¸€ä¸ªå“åº”å¼å¯¹è±¡å‘¢ï¼Ÿå¤§å®¶è‚¯å®šéƒ½æƒ³åˆ°äº† `Object.defineProperty` å’Œ `Proxy` ã€‚

- å½“å‰¯ä½œç”¨å‡½æ•° `effect` æ‰§è¡Œæ—¶ï¼Œä¼šè§¦å‘å­—æ®µ` obj.age` çš„**è¯»å–**æ“ä½œï¼›
- å½“ä¿®æ”¹ `obj.age` çš„å€¼æ—¶ï¼Œä¼šè§¦å‘å­—æ®µ `obj.age` çš„**è®¾ç½®**æ“ä½œã€‚

æˆ‘ä»¬å¯ä»¥æŠŠå‰¯ä½œç”¨å‡½æ•°` effect` å­˜å‚¨åˆ°ä¸€ä¸ªâ€œæ¡¶â€é‡Œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![image-20240117105714532](https://qn.huat.xyz/mac/202401171057575.png)

æ¥ç€ï¼Œå½“è®¾ç½® `obj.age` æ—¶ï¼Œå†æŠŠå‰¯ä½œç”¨å‡½æ•° `effect` ä»â€œæ¡¶â€é‡Œå–å‡ºå¹¶æ‰§è¡Œå³å¯ã€‚

![image-20240117110913570](https://qn.huat.xyz/mac/202401171109611.png)

### ä»£ç å®ç°

```javascript
// å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶
const bucket = new Set();

// åŸå§‹æ•°æ®
const data = { name: 'dahuang', age: 18 };

// å¯¹åŸå§‹æ•°æ®çš„ä»£ç†
const obj = new Proxy(data, {
  // æ‹¦æˆªè¯»å–æ“ä½œ
  get(target, key) {
    // å°†å‰¯ä½œç”¨å‡½æ•° effect æ·»åŠ åˆ°å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶ä¸­
    bucket.add(effect);
    // è¿”å›å±æ€§å€¼
    return target[key];
  },
  // æ‹¦æˆªè®¾ç½®æ“ä½œ
  set(target, key, newVal) {
    target[key] = newVal;
    bucket.forEach(fn => fn());
    return true;
  }
});

// ä»¥ä¸‹ä¸ºæµ‹è¯•ä»£ç 
// å‰¯ä½œç”¨å‡½æ•°
function effect() {
  console.log(obj.age);
}

// æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œè§¦å‘è¯»å–
effect();

// 1 ç§’åä¿®æ”¹å“åº”å¼æ•°æ®
setTimeout(() => {
  obj.age = 23;
}, 1000);
```

åœ¨æµè§ˆå™¨ä¸­ç›´æ¥è¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°æœŸæœ›çš„æ•ˆæœã€‚

ä½†ç›®å‰çš„å®ç°è¿˜å­˜åœ¨ä¸€äº›ç¼ºé™·ï¼š

- ç›´æ¥é€šè¿‡åå­—`effect`æ¥è·å–å‰¯ä½œç”¨å‡½æ•°ï¼Œå¦‚æœåç§°å˜äº†æ€ä¹ˆåŠï¼Ÿ
- å½“æˆ‘ä»¬åœ¨ä¿®æ”¹ `name` çš„æ—¶å€™ï¼Œå‰¯ä½œç”¨å‡½æ•°ä¾ç„¶ä¼šæ‰§è¡Œ

åç»­ä¼šé€æ­¥è§£å†³è¿™äº›é—®é¢˜ï¼Œè¿™é‡Œå¤§å®¶åªéœ€è¦ç†è§£å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°å’Œå·¥ä½œåŸç†å³å¯ã€‚





## å®Œå–„çš„å“åº”ç³»ç»Ÿ

### è§£å†³ç¡¬ç¼–ç å‰¯ä½œç”¨å‡½æ•°åå­—é—®é¢˜

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ªç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°çš„æœºåˆ¶ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š

```ts
// å½“å‰æ¿€æ´»çš„å‰¯ä½œç”¨å‡½æ•°
let currentEffect = null;

// å®šä¹‰å‰¯ä½œç”¨å‡½æ•°
export function effect(fn) {
  // è®¾ç½®å½“å‰æ¿€æ´»çš„å‰¯ä½œç”¨å‡½æ•°
  currentEffect = fn;
  // æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
  fn();
  // é‡ç½®å½“å‰æ¿€æ´»çš„å‰¯ä½œç”¨å‡½æ•°
  currentEffect = null;
}
```

é¦–å…ˆï¼Œå®šä¹‰äº†ä¸€ä¸ªå…¨å±€å˜é‡ `activeEffect`ï¼Œåˆå§‹å€¼æ˜¯ `null`ï¼Œå®ƒçš„ä½œç”¨æ˜¯å­˜å‚¨è¢«æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°ã€‚æ¥ç€é‡æ–°å®šä¹‰äº† `effect` å‡½æ•°ï¼Œå®ƒå˜æˆäº†ä¸€ä¸ªç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°çš„å‡½æ•°ï¼Œ`effect` å‡½æ•°æ¥æ”¶ä¸€ä¸ªå‚æ•°` fn`ï¼Œå³è¦æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ‰€ç¤ºçš„æ–¹å¼ä½¿ç”¨`effect` å‡½æ•°ï¼š

```js
effect(() => {
  console.log(obj.age);
})
```

å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œç”±äºå‰¯ä½œç”¨å‡½æ•°å·²ç»å­˜å‚¨åˆ°äº† activeEffectä¸­ï¼Œæ‰€ä»¥åœ¨ getæ‹¦æˆªå‡½æ•°å†…åº”è¯¥æŠŠ activeEffectæ”¶é›†åˆ°â€œæ¡¶â€ä¸­ï¼Œè¿™æ ·å“åº”ç³»ç»Ÿå°±ä¸ä¾èµ–å‰¯ä½œç”¨å‡½æ•°çš„åå­—äº†ã€‚

```js
get(target, key) {
  // å°† currentEffect æ·»åŠ åˆ°å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶ä¸­
  if (currentEffect) {
    bucket.add(currentEffect);
  }
  // è¿”å›å±æ€§å€¼
  return target[key];
},
```

